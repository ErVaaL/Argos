<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MongoMeasurementRepositoryAdapter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">argos-mongo-adapter</a> &gt; <a href="index.source.html" class="el_package">com.erval.argos.mongo</a> &gt; <span class="el_source">MongoMeasurementRepositoryAdapter.java</span></div><h1>MongoMeasurementRepositoryAdapter.java</h1><pre class="source lang-java linenums">package com.erval.argos.mongo;

import java.util.List;
import java.util.Optional;

import com.erval.argos.core.application.PageRequest;
import com.erval.argos.core.application.PageResult;
import com.erval.argos.core.application.SortDirection;
import com.erval.argos.core.application.port.in.queries.MeasurementQueryUseCase.MeasurementFilter;
import com.erval.argos.core.application.port.out.MeasurementRepositoryPort;
import com.erval.argos.core.domain.measurement.Measurement;
import com.erval.argos.mongo.model.MeasurementDocument;
import com.erval.argos.mongo.repositories.MeasurementMongoRepository;

import org.springframework.data.domain.Sort;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.mongodb.core.MongoTemplate;
import org.springframework.data.mongodb.core.query.Criteria;
import org.springframework.data.mongodb.core.query.Query;
import org.springframework.stereotype.Component;

import lombok.RequiredArgsConstructor;

/**
 * MongoDB-backed adapter for measurement persistence.
 * &lt;p&gt;
 * Provides:
 * &lt;ul&gt;
 * &lt;li&gt;filtering by device, type, and timestamp ranges&lt;/li&gt;
 * &lt;li&gt;paged retrieval with caller-driven sorting&lt;/li&gt;
 * &lt;li&gt;conversion between domain aggregates and Mongo documents&lt;/li&gt;
 * &lt;/ul&gt;
 */
@Component
@RequiredArgsConstructor
public class MongoMeasurementRepositoryAdapter implements MeasurementRepositoryPort {
    private final MeasurementMongoRepository repo;
    private final MongoTemplate mongoTemplate;

    /**
     * Removes all measurements belonging to a device.
     *
     * @param deviceId device identifier to delete measurements for
     */
    @Override
    public void deleteByDeviceId(String deviceId) {
<span class="fc" id="L48">        Query query = new Query(Criteria.where(&quot;deviceId&quot;).is(deviceId));</span>
<span class="fc" id="L49">        mongoTemplate.remove(query, MeasurementDocument.class);</span>
<span class="fc" id="L50">    }</span>

    /**
     * Executes a paginated search applying filter criteria and sorting
     * instructions.
     * &lt;p&gt;
     * Defaults to sorting by {@code timestamp} when the caller provides no sort
     * field.
     *
     * @param filter      constraints like device id, type, or time interval
     * @param pageRequest paging and sorting instructions
     * @return a page of domain measurements
     */
    @Override
    public PageResult&lt;Measurement&gt; findByFilter(MeasurementFilter filter, PageRequest pageRequest) {
<span class="fc" id="L65">        Query query = new Query();</span>

<span class="pc bpc" id="L67" title="1 of 2 branches missed.">        if (filter != null) {</span>
<span class="pc bpc" id="L68" title="2 of 4 branches missed.">            if (filter.deviceId() != null &amp;&amp; !filter.deviceId().isBlank()) {</span>
<span class="fc" id="L69">                query.addCriteria(Criteria.where(&quot;deviceId&quot;).is(filter.deviceId()));</span>
            }
<span class="pc bpc" id="L71" title="1 of 2 branches missed.">            if (filter.type() != null) {</span>
<span class="fc" id="L72">                query.addCriteria(Criteria.where(&quot;type&quot;).is(filter.type()));</span>
            }
<span class="fc" id="L74">            Criteria ts = null;</span>
<span class="fc bfc" id="L75" title="All 2 branches covered.">            if (filter.from() != null) {</span>
<span class="fc" id="L76">                ts = Criteria.where(&quot;timestamp&quot;).gte(filter.from());</span>
            }
<span class="fc bfc" id="L78" title="All 2 branches covered.">            if (filter.to() != null) {</span>
<span class="pc bpc" id="L79" title="1 of 2 branches missed.">                ts = (ts == null ? Criteria.where(&quot;timestamp&quot;) : ts).lte(filter.to());</span>
            }
<span class="fc bfc" id="L81" title="All 2 branches covered.">            if (ts != null) {</span>
<span class="fc" id="L82">                query.addCriteria(ts);</span>
            }
        }

<span class="fc" id="L86">        Sort sort = Sort.by(</span>
<span class="pc bpc" id="L87" title="1 of 2 branches missed.">                pageRequest.direction() == SortDirection.ASC</span>
<span class="fc" id="L88">                        ? Sort.Direction.ASC</span>
<span class="pc" id="L89">                        : Sort.Direction.DESC,</span>
<span class="pc bpc" id="L90" title="2 of 4 branches missed.">                pageRequest.sortBy() != null &amp;&amp; !pageRequest.sortBy().isBlank()</span>
<span class="fc" id="L91">                        ? pageRequest.sortBy()</span>
<span class="pc" id="L92">                        : &quot;timestamp&quot;);</span>

<span class="fc" id="L94">        org.springframework.data.domain.PageRequest pageable = org.springframework.data.domain.PageRequest</span>
<span class="fc" id="L95">                .of(pageRequest.page(), pageRequest.size(), sort);</span>

<span class="fc" id="L97">        long total = mongoTemplate.count(query, MeasurementDocument.class);</span>
<span class="fc" id="L98">        List&lt;MeasurementDocument&gt; docs = mongoTemplate.find(query.with(pageable), MeasurementDocument.class);</span>

<span class="fc" id="L100">        List&lt;Measurement&gt; content = docs.stream()</span>
<span class="fc" id="L101">                .map(MeasurementDocument::toDomain)</span>
<span class="fc" id="L102">                .toList();</span>

<span class="fc" id="L104">        return new PageResult&lt;&gt;(</span>
                content,
                total,
<span class="fc" id="L107">                pageRequest.page(),</span>
<span class="fc" id="L108">                pageRequest.size());</span>
    }

    /**
     * Saves a measurement aggregate by persisting a Mongo document.
     *
     * @param measurement aggregate to persist
     * @return saved domain measurement
     */
    @Override
    public Measurement save(Measurement measurement) {
<span class="fc" id="L119">        MeasurementDocument saved = repo.save(MeasurementDocument.fromDomain(measurement));</span>
<span class="fc" id="L120">        return saved.toDomain();</span>
    }

    @Override
    /**
     * Deletes a measurement by its id.
     *
     * @param id measurement identifier
     */
    public void deleteById(String id) {
<span class="fc" id="L130">        repo.deleteById(id);</span>
<span class="fc" id="L131">    }</span>

    /**
     * Retrieves all measurements with paging and sorting.
     *
     * @param pageRequest paging and sorting instructions
     * @return paged measurements
     */
    @Override
    public PageResult&lt;Measurement&gt; findAll(PageRequest pageRequest) {
<span class="fc" id="L141">        Pageable pageable = org.springframework.data.domain.PageRequest.of(</span>
<span class="fc" id="L142">                pageRequest.page(),</span>
<span class="fc" id="L143">                pageRequest.size(),</span>
<span class="pc bpc" id="L144" title="1 of 2 branches missed.">                pageRequest.direction() == SortDirection.ASC ? Sort.Direction.ASC : Sort.Direction.DESC,</span>
<span class="pc bpc" id="L145" title="1 of 4 branches missed.">                pageRequest.sortBy() != null &amp;&amp; !pageRequest.sortBy().isBlank() ? pageRequest.sortBy() : &quot;timestamp&quot;);</span>

<span class="fc" id="L147">        Page&lt;MeasurementDocument&gt; page = repo.findAll(pageable);</span>
<span class="fc" id="L148">        List&lt;Measurement&gt; content = page.getContent().stream()</span>
<span class="fc" id="L149">                .map(MeasurementDocument::toDomain)</span>
<span class="fc" id="L150">                .toList();</span>

<span class="fc" id="L152">        return new PageResult&lt;&gt;(</span>
                content,
<span class="fc" id="L154">                page.getTotalElements(),</span>
<span class="fc" id="L155">                page.getNumber(),</span>
<span class="fc" id="L156">                page.getSize());</span>
    }

    @Override
    /**
     * Retrieves a measurement by id.
     *
     * @param id measurement identifier
     * @return optional measurement if found
     */
    public Optional&lt;Measurement&gt; findById(String id) {
<span class="fc" id="L167">        return repo.findById(id).map(MeasurementDocument::toDomain);</span>
    }

    /**
     * Deletes all measurements in the repository.
     */
    @Override
    public void deleteAll() {
<span class="fc" id="L175">        repo.deleteAll();</span>
<span class="fc" id="L176">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>